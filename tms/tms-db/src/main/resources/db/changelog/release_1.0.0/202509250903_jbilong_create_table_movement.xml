<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <changeSet id="202509250903_jbilong_create_table_movement" author="jbilong">
        <createTable tableName="movement" schemaName="tms">
            <column name="id" type="BIGINT" autoIncrement="true" startWith="1" incrementBy="1">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="version" type="BIGINT"/>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE"/>

            <column name="movement_type" type="VARCHAR(10)">
                <constraints nullable="false"/>
            </column>
            <column name="movement_time" type="TIMESTAMP WITH TIME ZONE" >
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="VARCHAR(255)"/>
            <column name="customs_status" type="VARCHAR(16)"/>

            <!-- embbeded goods fields -->
            <column name="goods_ref_type" type="VARCHAR(10)">
                <constraints nullable="false"/>
            </column>
            <column name="goods_ref_code" type="VARCHAR(64)">
                <constraints nullable="false"/>
            </column>
            <column name="quantity" type="NUMERIC(15,2)"/>
            <column name="weight" type="NUMERIC(15,2)"/>
            <column name="total_quantity" type="NUMERIC(15,2)"/>
            <column name="total_weight" type="NUMERIC(15,2)"/>
            <column name="description" type="VARCHAR(255)"/>

            <!-- embbeded customs_documentds fields -->
            <column name="customs_doc_type" type="VARCHAR(32)"/>
            <column name="customs_doc_ref" type="VARCHAR(128)"/>

            <column name="declared_in_id" type="BIGINT"/>
            <column name="from_warehouse_id" type="BIGINT"/>
            <column name="to_warehouse_id" type="BIGINT"/>
        </createTable>

        <!-- Indexes -->
        <createIndex indexName="ix_movement_time"
                     schemaName="tms"
                     tableName="movement">
            <column name="movement_time"/>
        </createIndex>

         <!-- Index composite -->
        <createIndex indexName="ix_goods_ref"
                     schemaName="tms"
                     tableName="movement">
            <column name="goods_ref_type"/>
            <column name="goods_ref_code"/>
        </createIndex>

        <!-- FK vers warehouse -->
        <addForeignKeyConstraint constraintName="fk_movement_declared_in"
                                 baseTableSchemaName="tms"
                                 baseTableName="movement"
                                 baseColumnNames="declared_in_id"
                                 referencedTableName="warehouse"
                                 referencedColumnNames="id"
                                 onDelete="RESTRICT"/>
        <addForeignKeyConstraint constraintName="fk_movement_from_wh"
                                 baseTableSchemaName="tms"
                                 baseTableName="movement"
                                 baseColumnNames="from_warehouse_id"
                                 referencedTableName="warehouse"
                                 referencedColumnNames="id"
                                 onDelete="RESTRICT"/>
        <addForeignKeyConstraint constraintName="fk_movement_to_wh"
                                 baseTableSchemaName="tms"
                                 baseTableName="movement"
                                 baseColumnNames="to_warehouse_id"
                                 referencedTableName="warehouse"
                                 referencedColumnNames="id"
                                 onDelete="RESTRICT"/>

    </changeSet>
    <!-- Enum CHECK constraint -->
    <changeSet id="202509250903_jbilong_ck_movement_type" author="jbilong">
        <sql>alter table tms.movement add constraint ck_movement_type check (movement_type in ('IN','OUT'));</sql>
    </changeSet>
     <!-- Enum CHECK constraint -->
    <changeSet id="202509250903_jbilong_ck_goods_ref_type" author="jbilong">
        <sql>alter table tms.movement add constraint ck_goods_ref_type check (goods_ref_type in ('AWB','OTHER'));</sql>
    </changeSet>
</databaseChangeLog>
